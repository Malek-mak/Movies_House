{% extends 'Movies/core.html' %}
{% block title %}Edit{% endblock %}

{% block content %}
<h1 class="text-white font-bold text-4xl">Edit Ticket</h1><br><hr><br>
    <div class="columns-2xs gap-6">
        <div class="aspect-1/3 p-2">
                <figure class="pb-2">
                    <img src="{{ ticket.movie.image.url }}">
                </figure>
        </div>
                        <div class="p-2 aspect-2/3 ">
                            
                        <h1 class="text-white text-4xl font-bold">{{ ticket.movie.name }}</h1><br>
                        <h2 class="text-gray-500 font-semibold">Duration: {{ ticket.movie.duration }}</h2>
                        <h2 class="text-gray-500 font-semibold">Rating: {{ ticket.movie.rating }} ‚≠ê</h2>
                        <h2 class="text-gray-500 font-semibold">Year: {{ ticket.movie.year }}</h2>
                        <p class="text-white font-semibold">
                            {% for genre in ticket.movie.genre.all %}
                               <span class=""> {{ genre }},  </span>
                            {% endfor %}</p>
                        <h2 class="text-white font-semibold">Ticket Price: {{ ticket.movie.price }}</h2>
                        <ul class="text-white font-semibold">
                            {% for d in ticket.movie.showtimes.all %}
                                <li>{{ d.date }}</li>
                    
                                <p class="text-white">Seats left: {{ d.tickets_left }}</p>
                                
                            {% endfor %}
                        </ul>
                        <br>
                        </div>
                    {% if request.user.is_authenticated %}
                        <form method="post" id="ticket-form">
                            {% csrf_token %}
                            
                            <!-- Date dropdown -->

                            {{ form.date }}
                            
                            <!-- Hidden seat input (gets filled from popup) -->
                            <input type="hidden"  name="seat" id="seat-input">
                            <span class="font-bold px-4 py-2 bg-yellow-600 rounded-lg hidden" id="seat-label"></span>
                            <button type="submit" id="sbt-btn" class="btn btn-primary px-6 py-2 bg-yellow-600 hidden m-2">Book</button>
                        </form>

                        <!-- Popup modal -->
                        <div id="seat-modal" class="modal" style="display: none;">
                            <div class="modal-content">
                                <span id="close-modal">&times;</span>
                                <h2>Select a seat</h2>
                                <div id="seat-container">
                                    <!-- seats will be loaded here -->
                                </div>
                            </div>
                        </div>
                   
                    {% endif %}
                        <style>
                        .modal {
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);

                            width: 95%;
                            max-width: 600px;
                            height: auto;
                            max-height: 90vh;

                            background: rgba(0, 0, 0, 0.6);
                            display: grid;

                            grid-template-columns: repeat(auto-fit, minmax(32px, 1fr));
                            gap: 6px;

                            padding: 12px;
                            overflow-y: auto;
                        }

                        /* Modal content */
                        .modal-content {
                            background: white;
                            padding: 16px;
                            border-radius: 8px;
                        }

                        /* Seat buttons */
                        #seat-container button {
                            padding: 8px;
                            font-size: 12px;
                            border: 1px solid #ccc;
                            background-color: green;
                            border-radius: 4px;
                        }

                        /* Tablets and up */
                        @media (min-width: 768px) {
                            .modal {
                                width: 70%;
                                max-width: 800px;
                                gap: 8px;
                            }

                            #seat-container button {
                                padding: 10px;
                                font-size: 14px;
                            }
                        }

                        /* Desktop */
                        @media (min-width: 1024px) {
                            .modal {
                                width: 50%;
                            }
                        }
                    </style>
            </div>
        <div class="container py-6 px-4 bg-neutral-800 m-4 rounded-lg">
            <h2 class="text-white font-semibold">Discription: </h2><br>
                <p class="text-white">
                    {{ ticket.movie.discription }}
                </p>
        </div>
        <script>
            
       
            document.addEventListener("DOMContentLoaded", function () {
                const dateSelect = document.getElementById("id_date");
                const seatModal = document.getElementById("seat-modal");
                const seatContainer = document.getElementById("seat-container");
                const seatInput = document.getElementById("seat-input");
                const closeModal = document.getElementById("close-modal");
                const subbtn = document.getElementById("sbt-btn");
                const seatlabel = document.getElementById("seat-label");
                const movieId = "{{ ticket.movie.id }}";  // passed from view

                // Open modal when date is selected
                dateSelect.addEventListener("change", function () {
                    const dateId = this.value;
                    if (dateId) {
                        fetch(`/available-seats/${movieId}/${dateId}/`)
                            .then(response => response.json())
                            .then(data => {
                                seatContainer.innerHTML = "";
                                data.forEach(seat => {
                                    const btn = document.createElement("button");
                                    btn.type = "button";
                                    btn.textContent = seat.label;
                                    btn.addEventListener("click", function () {
                                        seatInput.value = seat.id; // set hidden input
                                        
                                        seatModal.style.display = "none"; // close popup
                                        seatlabel.innerHTML = seat.label;
                                        seatlabel.classList.remove('hidden');
                                        subbtn.classList.remove('hidden');


                                    });
                                    seatContainer.appendChild(btn);
                                });
                                seatModal.style.display = "flex";
                            });
                    }
                });

                // Close modal
                closeModal.addEventListener("click", function () {
                    seatModal.style.display = "none";
                });
            });

        </script>
{% endblock %}